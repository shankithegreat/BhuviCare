define(["durandal/system", "durandal/composition", "jquery", "knockout"], function (n, i, t, e) { function d(n, t) { var d = e.utils.domData.get(n, s); d || (d = { parts: i.cloneNodes(e.virtualElements.childNodes(n)) }, e.virtualElements.emptyNode(n), e.utils.domData.set(n, s, d)), t.parts = d.parts } var o = {}, r = {}, a = ["model", "view", "kind"], s = "durandal-widget-data", u = { getSettings: function (i) { var t = e.utils.unwrapObservable(i()) || {}; if (n.isString(t)) return { kind: t }; for (var d in t) -1 != e.utils.arrayIndexOf(a, d) ? t[d] = e.utils.unwrapObservable(t[d]) : t[d] = t[d]; return t }, registerKind: function (n) { e.bindingHandlers[n] = { init: function () { return { controlsDescendantBindings: !0 } }, update: function (i, t, e, o, r) { var a = u.getSettings(t); a.kind = n, d(i, a), u.create(i, a, r, !0) } }, e.virtualElements.allowedBindings[n] = !0, i.composeBindings.push(n + ":") }, mapKind: function (n, i, t) { i && (r[n] = i), t && (o[n] = t) }, mapKindToModuleId: function (n) { return o[n] || u.convertKindToModulePath(n) }, convertKindToModulePath: function (n) { return "widgets/" + n + "/viewmodel" }, mapKindToViewId: function (n) { return r[n] || u.convertKindToViewPath(n) }, convertKindToViewPath: function (n) { return "widgets/" + n + "/view" }, createCompositionSettings: function (n, i) { return i.model || (i.model = this.mapKindToModuleId(i.kind)), i.view || (i.view = this.mapKindToViewId(i.kind)), i.preserveContext = !0, i.activate = !0, i.activationData = i, i.mode = "templated", i }, create: function (n, t, e, d) { d || (t = u.getSettings(function () { return t }, n)); var o = u.createCompositionSettings(n, t); i.compose(n, o, e) }, install: function (n) { if (n.bindingName = n.bindingName || "widget", n.kinds) for (var t = n.kinds, o = 0; o < t.length; o++) u.registerKind(t[o]); e.bindingHandlers[n.bindingName] = { init: function () { return { controlsDescendantBindings: !0 } }, update: function (n, i, t, e, o) { var r = u.getSettings(i); d(n, r), u.create(n, r, o, !0) } }, i.composeBindings.push(n.bindingName + ":"), e.virtualElements.allowedBindings[n.bindingName] = !0 } }; return u });